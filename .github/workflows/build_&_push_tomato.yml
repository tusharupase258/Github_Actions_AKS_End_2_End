name: build_&_push_tomato
on: 
   workflow_dispatch: 
   push:
    branches:
      - main
permissions:
  id-token: write
  contents: read
  
jobs:
 build-and-push:
  runs-on: ubuntu-latest

  env:
    ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
    ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
    ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
    ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
    ACR_NAME: ${{ secrets.ARM_NAME }}
    ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
    
  steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Azure Login
      uses: Azure/login@v2.3.0
      with:
         client-id: ff27bcf6-f60c-4a57-8b01-8eee5de2a9cd
         tenant-id: 0f7010fd-209e-4344-8457-043ffb37143b
         subscription-id: 1075ec7a-b17a-4f37-bf3f-9d68c4506dc1
         
    - name: Log in to ACR
      run: |
        az acr login --name $ACR_NAME
        
    - name: Build Docker Image
      run: |
        docker build -t $IMAGE_NAME:$IMAGE_TAG .
        
    - name: Tag Docker Image for ACR
      run: |
        docker tag $IMAGE_NAME:$IMAGE_TAG $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG

    - name: Push Docker Image to ACR
      run: |
         docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG
